name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  BUN_VERSION: "1.1.38"

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Generate CalVer version
        id: version
        run: |
          # CalVer format: YYYY.MM.DD.RUN_NUMBER
          DATE_PART=$(date +%Y.%-m.%-d)
          VERSION="${DATE_PART}.${{ github.run_number }}"
          TAG="v${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

  build:
    needs: version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: bun-linux-x64
            artifact: x86_64-linux
          - target: bun-linux-arm64
            artifact: aarch64-linux
          - target: bun-darwin-x64
            artifact: x86_64-darwin
          - target: bun-darwin-arm64
            artifact: aarch64-darwin
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Build binaries
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          mkdir -p dist/bin

          # Build pyxis CLI with version injected
          bun build src/cli/bin.ts --compile --target=${{ matrix.target }} \
            --define "__VERSION__=\"${VERSION}\"" \
            --outfile=dist/bin/pyxis-${{ matrix.artifact }}

          # Make executable
          chmod +x dist/bin/*

          # Show what we built
          ls -la dist/bin/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.artifact }}
          path: dist/bin/*
          if-no-files-found: error

  release:
    needs: [version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate checksums
        working-directory: artifacts
        run: |
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.version.outputs.tag }}
          tag_name: ${{ needs.version.outputs.tag }}
          body: |
            ## pyxis ${{ needs.version.outputs.version }}

            Rolling release from `main` branch.

            ### Installation

            **Via Nix Flake (recommended):**
            ```bash
            nix run github:simonwjackson/pyxis
            ```

            **Via FlakeHub:**
            ```bash
            nix run "https://flakehub.com/f/simonwjackson/pyxis/*.tar.gz"
            ```

            **Manual download:**
            Download the appropriate binary for your platform below and make it executable:
            ```bash
            chmod +x pyxis-*
            ./pyxis-x86_64-linux --help
            ```

            ### Binaries

            | Platform | Binary |
            |----------|--------|
            | Linux x86_64 | `pyxis-x86_64-linux` |
            | Linux ARM64 | `pyxis-aarch64-linux` |
            | macOS x86_64 | `pyxis-x86_64-darwin` |
            | macOS ARM64 | `pyxis-aarch64-darwin` |

            ### Checksums
            See `SHA256SUMS` for file checksums.
          files: |
            artifacts/*
          fail_on_unmatched_files: true
          make_latest: true

  flakehub:
    needs: [version, release]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/flakehub-push@main
        with:
          name: simonwjackson/pyxis
          rolling: true
          visibility: public
